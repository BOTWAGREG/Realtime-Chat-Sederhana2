<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Realtime Chat</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- TAMBAHAN: Header baru yang menampilkan info user dan tombol logout -->
  <div class="header">
    <h2>Realtime Chat</h2>
    <div class="user-info" id="userInfo">
      <!-- Span untuk menampilkan nama username yang sedang login -->
      <span id="username"></span>
      <!-- Tombol logout untuk keluar dari aplikasi -->
      <button onclick="logout()" class="logout-btn">Log Out</button>
    </div>
  </div>
  
  <div id="chat"></div>
  <!-- PERUBAHAN: Input dan button dibungkus dalam container untuk styling yang lebih baik -->
  <div class="input-container">
    <!-- PERUBAHAN: Input disabled secara default, hanya aktif setelah user login -->
    <input id="message" placeholder="Ketik pesan..." disabled />
    <!-- PERUBAHAN: Button disabled secara default, hanya aktif setelah user login -->
    <button onclick="sendMessage()" id="sendBtn" disabled>Kirim</button>
  </div>

  <script type="module">
    // TAMBAHAN: Import Firebase modules untuk autentikasi
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    // onAuthStateChanged: untuk mendeteksi perubahan status login user
    // signOut: untuk logout user
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    
    // Konfigurasi Firebase (sama seperti sebelumnya)
    const firebaseConfig = {
      apiKey: "AIzaSyAD9PuaSWK6-rK1B0VKIrY1dgQsK6CevNk",
      authDomain: "website-mapel-digital.firebaseapp.com",
      projectId: "website-mapel-digital",
      storageBucket: "website-mapel-digital.firebasestorage.app",
      messagingSenderId: "237511903481",
      appId: "1:237511903481:web:50105212d92efdfc6aba28",
      measurementId: "G-TTZQ3NTRZ9"
    };

    // Inisialisasi Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // TAMBAHAN: Variabel untuk menyimpan WebSocket connection dan user yang sedang login
    let socket;
    let currentUser = null;
    // Ambil elemen-elemen DOM yang akan digunakan
    const chat = document.getElementById("chat");
    const input = document.getElementById("message");
    const sendBtn = document.getElementById("sendBtn");
    const usernameSpan = document.getElementById("username");

    // TAMBAHAN: Fungsi untuk memonitor status autentikasi user
    // onAuthStateChanged dipanggil setiap kali status login user berubah
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // Jika user sudah login
        console.log("User logged in:", user.email);
        currentUser = user;
        
        // Ambil username dari localStorage, jika tidak ada gunakan email tanpa domain
        const username = localStorage.getItem('username') || user.email.split('@')[0];
        usernameSpan.textContent = `Halo, ${username}!`;
        
        // AKTIVASI CHAT: Enable input dan button setelah user login
        input.disabled = false;
        sendBtn.disabled = false;
        input.placeholder = "Ketik pesan...";
        
        // Inisialisasi koneksi WebSocket setelah user login
        initWebSocket();
      } else {
        // Jika user belum login, redirect ke halaman login
        console.log("User not logged in, redirecting to login");
        window.location.href = "login.html";
      }
    });

    // TAMBAHAN: Fungsi untuk menginisialisasi koneksi WebSocket
    function initWebSocket() {
      socket = new WebSocket("ws://localhost:8080");
      
      // Handle pesan yang diterima dari server
      socket.onmessage = (event) => {
        const data = JSON.parse(event.data);

        // Ketika client baru connect, server kirim semua pesan lama
        if (data.type === "init") {
          chat.innerHTML = "";
          data.messages.forEach(renderMessage);
        }

        // Ketika ada pesan baru dari user lain
        if (data.type === "chat") {
          renderMessage(data.message);
        }

        // Ketika ada pesan yang dihapus
        if (data.type === "delete") {
          const el = document.getElementById("msg-" + data.id);
          if (el) el.remove();
        }
      };

      // Handle error koneksi WebSocket
      socket.onerror = (error) => {
        console.error('WebSocket error:', error);
        alert('Gagal terhubung ke server chat');
      };
    }

    // PERUBAHAN: Fungsi render pesan dengan tambahan username dan tombol hapus conditional
    function renderMessage(msg) {
      const div = document.createElement("div");
      div.className = "msg";
      div.id = "msg-" + msg.id;
      
      // TAMBAHAN: Cek apakah pesan ini milik user yang sedang login
      const isOwnMessage = msg.username === (localStorage.getItem('username') || currentUser.email.split('@')[0]);
      
      // PERUBAHAN: Template HTML yang menampilkan username dan pesan
      // Tombol hapus hanya muncul untuk pesan milik sendiri
      div.innerHTML = `
        <div class="message-content">
          <strong>${msg.username}:</strong> ${msg.text}
        </div>
        ${isOwnMessage ? `<button onclick="deleteMessage(${msg.id})" class="delete-btn">Hapus</button>` : ''}
      `;
      
      // TAMBAHAN: Styling khusus untuk pesan milik sendiri
      if (isOwnMessage) {
        div.classList.add('own-message');
      }
      
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight; // Auto-scroll ke pesan terbaru
    }

    // PERUBAHAN: Fungsi kirim pesan dengan validasi login dan username
    window.sendMessage = function() {
      // TAMBAHAN: Cek apakah user sudah login
      if (!currentUser) {
        alert('Anda harus login terlebih dahulu!');
        return;
      }
      
      const text = input.value.trim();
      if (!text) return alert("Pesan tidak boleh kosong!");
      
      // TAMBAHAN: Ambil username dari localStorage atau gunakan email
      const username = localStorage.getItem('username') || currentUser.email.split('@')[0];
      
      // PERUBAHAN: Kirim pesan dengan username
      socket.send(JSON.stringify({ 
        type: "chat", 
        text: text,
        username: username  // TAMBAHAN: Include username dalam pesan
      }));
      
      console.log("Pesan terkirim:", text);
      input.value = "";
    }

    // PERUBAHAN: Fungsi hapus pesan dengan validasi login
    window.deleteMessage = function(id) {
      if (!currentUser) return; // Hanya user yang login bisa hapus pesan
      socket.send(JSON.stringify({ type: "delete", id }));
    }

    // TAMBAHAN: Fungsi logout menggunakan Firebase Auth
    window.logout = function() {
      signOut(auth).then(() => {
        // Hapus username dari localStorage
        localStorage.removeItem('username');
        console.log("User logged out");
        // Redirect ke halaman login
        window.location.href = "login.html";
      }).catch((error) => {
        console.error('Error signing out:', error);
        alert('Gagal logout');
      });
    }

    // TAMBAHAN: Event listener untuk mengirim pesan dengan tombol Enter
    input.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
  </script>
</body>
</html>