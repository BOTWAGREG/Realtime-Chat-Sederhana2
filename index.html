<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Realtime Chat</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="header">
    <h2>Realtime Chat</h2>
    <div class="user-info" id="userInfo">
      <span id="userEmail"></span>
      <button onclick="logout()" class="logout-btn">Log Out</button>
    </div>
  </div>

  <div id="chat"></div>
  <div class="input-container">
    <input id="message" placeholder="Ketik pesan..." disabled />
    <button onclick="sendMessage()" id="sendBtn" disabled>Kirim</button>
  </div>

  <script>
    async function initFirebase() {
      try {
        // Ambil config dari serverless function
        const res = await fetch('/api/firebase-config');
        const firebaseConfig = await res.json();

        // Inisialisasi Firebase
        const app = firebase.initializeApp(firebaseConfig);
        document.getElementById("status").textContent = "Firebase Loaded âœ…";
      } catch (err) {
        document.getElementById("status").textContent = "Error: " + err.message;
        console.error(err);
      }
    }

    initFirebase();
  </script>
  
  <script type="module">
    // PERUBAHAN: Import Firebase modules + Realtime Database
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    // TAMBAHAN: Import Realtime Database (menggantikan WebSocket!)
    import { getDatabase, ref, push, onValue, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: process.env.FIREBASE_APIKEY,
      authDomain: process.env.FIREBASE_AUTHDOMAIN,
      databaseURL: process.env.FIREBASE_DATABASEURL,
      projectId: process.env.FIREBASE_PROJECTID,
      storageBucket: process.env.FIREBASE_STORAGEBUCKET,
      messagingSenderId: process.env.FIREBASE_MESSAGINGSENDERID,
      appId: process.env.FIREBASE_APPID,
      measurementId: process.env.FIREBASE_MEASUREMENTID,
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app); // TAMBAHAN: Initialize Realtime Database

    // HAPUS: Tidak butuh WebSocket variables lagi
    let currentUser = null;
    const chat = document.getElementById("chat");
    const input = document.getElementById("message");
    const sendBtn = document.getElementById("sendBtn");
    const userEmailSpan = document.getElementById("userEmail");

    // Monitor authentication state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        const username = user.email.split('@')[0];
        console.log("User logged in email:", user.email);
        console.log("User logged in username:", username);
        userEmailSpan.textContent = `Halo, ${username}!`;

        // Enable chat functionality
        input.disabled = false;
        sendBtn.disabled = false;
        input.placeholder = "Ketik pesan...";

        // PERUBAHAN: Initialize Firebase Realtime listener (menggantikan WebSocket)
        initRealtimeListener();
      } else {
        console.log("User not logged in, redirecting to login");
        window.location.href = "login.html";
      }
    });

    // TAMBAHAN: Fungsi untuk listen real-time changes dari Firebase
    function initRealtimeListener() {
      // Reference ke 'messages' collection di Firebase Realtime Database
      const messagesRef = ref(database, 'messages');

      // MAGIC: onValue otomatis listen perubahan real-time!
      // Ini menggantikan socket.onmessage
      onValue(messagesRef, (snapshot) => {
        const data = snapshot.val();
        console.log("Messages updated from Firebase:", data);

        // Clear chat dan render ulang semua messages
        chat.innerHTML = "";

        if (data) {
          // Convert object ke array dan sort berdasarkan timestamp
          const messagesArray = Object.keys(data).map(key => ({
            id: key,
            ...data[key]
          })).sort((a, b) => a.timestamp - b.timestamp);

          // Render setiap message
          messagesArray.forEach(renderMessage);
        }
      }, (error) => {
        console.error("Firebase listener error:", error);
        alert('Gagal terhubung ke database');
      });
    }

    // Fungsi render message (sama seperti sebelumnya)
    function renderMessage(msg) {
      const div = document.createElement("div");
      div.className = "msg";
      div.id = "msg-" + msg.id;

      const isOwnMessage = msg.userEmail === currentUser.email;

      // Format timestamp untuk display
      const timestamp = new Date(msg.timestamp).toLocaleTimeString('id-ID', {
        hour: '2-digit',
        minute: '2-digit'
      });

      div.innerHTML = `
        <div class="message-content">
          <div class="message-header">
            <strong>${msg.userEmail}</strong>
            <span class="timestamp">${timestamp}</span>
          </div>
          <div class="message-text">${msg.text}</div>
        </div>
        ${isOwnMessage ? `<button onclick="deleteMessage('${msg.id}')" class="delete-btn">Hapus</button>` : ''}
      `;

      if (isOwnMessage) {
        div.classList.add('own-message');
      }

      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    // PERUBAHAN: Send message menggunakan Firebase push (menggantikan WebSocket)
    window.sendMessage = async function () {
      if (!currentUser) {
        alert('Anda harus login terlebih dahulu!');
        return;
      }

      const text = input.value.trim();
      if (!text) return alert("Pesan tidak boleh kosong!");

      try {
        // Reference ke messages collection
        const messagesRef = ref(database, 'messages');

        // MAGIC: push() otomatis generate unique ID dan broadcast ke semua client!
        await push(messagesRef, {
          userEmail: currentUser.email,
          text: text,
          timestamp: Date.now(), // Gunakan client timestamp untuk konsistensi
          uid: currentUser.uid    // Tambahan: simpan user ID untuk security
        });

        console.log("Pesan terkirim ke Firebase:", text);
        input.value = "";

      } catch (error) {
        console.error('Error sending message:', error);
        alert('Gagal mengirim pesan. Coba lagi.');
      }
    }

    // PERUBAHAN: Delete message menggunakan Firebase remove (menggantikan WebSocket)
    window.deleteMessage = async function (messageId) {
      if (!currentUser) return;

      try {
        // Reference ke specific message
        const messageRef = ref(database, `messages/${messageId}`);

        // MAGIC: remove() otomatis broadcast ke semua client!
        await remove(messageRef);

        console.log("Pesan dihapus:", messageId);

      } catch (error) {
        console.error('Error deleting message:', error);
        alert('Gagal menghapus pesan. Coba lagi.');
      }
    }

    // Logout function (sama seperti sebelumnya)
    window.logout = function () {
      signOut(auth).then(() => {
        console.log("User logged out");
        window.location.href = "login.html";
      }).catch((error) => {
        console.error('Error signing out:', error);
        alert('Gagal logout');
      });
    }

    // Enter key listener
    input.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
  </script>
</body>

</html>